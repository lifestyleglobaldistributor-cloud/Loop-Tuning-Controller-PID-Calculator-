<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Philippine Flag DCS Engineer Tool</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003087">
<style>
  :root{--pri:#4fc3f7;--suc:#4caf50;--dan:#d32f2f;--bg:#0f3460;--dark:#003087;--light:#e0e0e0}
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--light);padding:15px;min-height:100vh;position:relative}
  .c{max-width:1000px;margin:auto;background:var(--bg);border-radius:15px;overflow:hidden;box-shadow:0 10px 40px #0008}
  header{background:var(--dark);padding:25px;text-align:center;color:#fff;border-bottom:8px solid #fce300;position:relative}
  header img{width:90px;height:90px;border-radius:50%;border:4px solid #fff;position:absolute;top:15px;right:15px;object-fit:cover}
  h1{font-size:22px;margin:8px 0}
  nav[role="tablist"]{display:flex;background:#1a1a2e;overflow-x:auto}
  .tab{flex:1;padding:16px 20px;background:#1a1a2e;color:#ccc;border:none;font-weight:bold;cursor:pointer;transition:.2s}
  .tab:focus{outline:3px solid var(--pri);outline-offset:-3px}
  .tab.active,.tab[aria-selected="true"]{color:var(--pri);border-bottom:4px solid var(--pri);background:#0f3460}
  .sec{padding:20px;display:none;background:#1a1a2e;margin:15px;border-radius:12px;border-left:5px solid var(--suc)}
  .sec.active{display:block}
  .sec[aria-hidden="true"]{display:none}
  label{display:block;margin:12px 0 6px;color:var(--pri);font-weight:bold}
  input,select{width:100%;padding:14px;background:var(--dark);border:2px solid var(--dark);border-radius:8px;color:#fff;font-size:16px}
  input:focus, select:focus{border-color:var(--pri);outline:none}
  .row{display:grid;gap:15px;grid-template-columns:1fr}
  @media(min-width:600px){.row{grid-template-columns:1fr 1fr}}
  .btn{width:100%;padding:16px;margin:12px 0;border:none;border-radius:8px;font-size:17px;font-weight:bold;cursor:pointer}
  .pri{background:var(--pri);color:#000}
  .suc{background:var(--suc);color:#fff}
  .dan{background:var(--dan);color:#fff}
  .res{background:var(--dark);padding:20px;border-radius:10px;margin-top:20px;position:relative}
  .it{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #0f3460;font-size:16px}
  .del-btn{position:absolute;top:10px;right:10px;background:var(--dan);color:#fff;padding:6px 10px;border:none;border-radius:6px;font-size:12px;cursor:pointer}
  .check-item{display:flex;align-items:center;margin:12px 0;background:var(--dark);padding:12px;border-radius:8px}
  .check-item input{margin-right:15px;width:24px;height:24px;accent-color:var(--suc)}
  #toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:16px 24px;border-radius:50px;box-shadow:0 4px 20px #0008;z-index:9999;opacity:0;transition:opacity .3s}
  #toast.show{opacity:1}
</style>
</head>
<body onload="init()">

<div id="toast"></div>

<div class="c">
  <header>
    <h1>Philippine Flag DCS Engineer Tool</h1>
    <p>PID • Converter • Checklist • 100% Offline</p>
    <img src="IMG_4645.jpeg" alt="Philippine DCS Logo">
  </header>

  <nav role="tablist" aria-label="Main tabs">
    <button id="tab-p0" class="tab active" type="button" role="tab" aria-selected="true" aria-controls="p0">PID Calculator</button>
    <button id="tab-p1" class="tab" type="button" role="tab" aria-selected="false" aria-controls="p1">Unit Converter</button>
    <button id="tab-p2" class="tab" type="button" role="tab" aria-selected="false" aria-controls="p2">Loop Checklist</button>
    <button id="tab-p3" class="tab" type="button" role="tab" aria-selected="false" aria-controls="p3">Saved Tunings</button>
  </nav>

  <div id="p0" class="sec active" role="tabpanel" aria-labelledby="tab-p0">
    <label for="tag">Loop Tag</label><input id="tag" type="text" placeholder="e.g. FIC-101">
    <div class="row">
      <div><label for="kp">Process Gain Kp</label><input id="kp" type="number" step="0.01"></div>
      <div><label for="dt">Dead Time θ (s)</label><input id="dt" type="number" step="0.1"></div>
    </div>
    <div class="row">
      <div><label for="tc">Time Constant τ (s)</label><input id="tc" type="number" step="0.1"></div>
      <div><label for="met">Method</label>
        <select id="met" onchange="document.getElementById('laf').style.display=this.value==='la'?'block':'none'">
          <option value="zn">Ziegler-Nichols</option>
          <option value="cc">Cohen-Coon</option>
          <option value="la">Lambda Tuning</option>
        </select>
      </div>
    </div>
    <div id="laf" style="display:none"><label for="lf">Lambda Factor</label><input id="lf" type="number" step="0.1" value="1"></div>
    <button class="btn pri" type="button" onclick="calc()">Calculate PID</button>

    <div id="res" class="res" style="display:none" data-ready="false">
      <h3 id="mt" style="color:var(--suc)"></h3>
      <div class="it"><span>Kc</span><span id="kc">-</span></div>
      <div class="it"><span>Ti (s)</span><span id="ti">-</span></div>
      <div class="it"><span>Td (s)</span><span id="td">-</span></div>
      <button class="btn suc" type="button" onclick="sav()">Save</button>
      <button class="btn suc" type="button" onclick="csv()">Export CSV</button>
      <button class="btn pri" type="button" onclick="wa()">Share WhatsApp</button>
    </div>
  </div>

  <div id="p1" class="sec" role="tabpanel" aria-labelledby="tab-p1">
    <label for="typ">Type</label>
    <select id="typ" onchange="up()">
      <option value="pres">Pressure</option>
      <option value="temp">Temperature</option>
      <option value="flow">Flow</option>
      <option value="curr">Current 4-20mA</option>
      <option value="pow">Power</option>
    </select>
    <div class="row">
      <div><label for="fv">Value</label><input id="fv" type="number" step="any" oninput="cv()"></div>
      <div><label for="fu">From</label><select id="fu" onchange="cv()"></select></div>
    </div>
    <div class="row">
      <div><label for="tv">Result</label><input id="tv" readonly style="font-size:22px;color:var(--suc);background:var(--dark)"></div>
      <div><label for="tu">To</label><select id="tu" onchange="cv()"></select></div>
    </div>
  </div>

  <div id="p2" class="sec" role="tabpanel" aria-labelledby="tab-p2">
    <h2 style="color:var(--suc)">Loop Commissioning Checklist</h2>
    <div class="check-item"><input type="checkbox" id="c1"><label for="c1">Field instrument calibration current</label></div>
    <div class="check-item"><input type="checkbox" id="c2"><label for="c2">Transmitter zero & span verified</label></div>
    <div class="check-item"><input type="checkbox" id="c3"><label for="c3">Wiring & terminations OK</label></div>
    <div class="check-item"><input type="checkbox" id="c4"><label for="c4">I/O card diagnostics clear</label></div>
    <div class="check-item"><input type="checkbox" id="c5"><label for="c5">DCS scaling & alarms correct</label></div>
    <div class="check-item"><input type="checkbox" id="c6"><label for="c6">Valve full stroke test done</label></div>
    <div class="check-item"><input type="checkbox" id="c7"><label for="c7">Valve stiction <2%</label></div>
    <div class="check-item"><input type="checkbox" id="c8"><label for="c8">Positioner & air supply OK</label></div>
    <button class="btn dan" type="button" onclick="resetCheck()">Reset All</button>
  </div>

  <div id="p3" class="sec" role="tabpanel" aria-labelledby="tab-p3">
    <button class="btn dan" type="button" onclick="if(confirm('Clear all?'))localStorage.removeItem('dcs_tunings'),load()">Clear All</button>
    <div id="list" style="margin-top:20px"></div>
  </div>
</div>

<script>
const conv={pres:{u:['bar','kg/cm²','psi','kPa'],f:{bar:1,'kg/cm²':0.980665,psi:14.5038,kPa:100}},
           temp:{u:['°C','°F','K']},
           flow:{u:['m³/h','L/min','US gpm'],f:{'m³/h':1,'L/min':0.06,'US gpm':0.2271}},
           curr:{u:['mA','%'],f:{mA:1,'%':0.0625}},
           pow:{u:['MW','kW','HP'],f:{MW:1,kW:1000,HP:1359.62}}};

// Toast instead of alert
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }

function tab(i){
  document.querySelectorAll('.sec').forEach((p,j)=>{ const a=j===i; p.classList.toggle('active',a); p.setAttribute('aria-hidden',a?'false':'true'); });
  document.querySelectorAll('.tab').forEach((b,j)=>{ const s=j===i; b.classList.toggle('active',s); b.setAttribute('aria-selected',s?'true':'false'); b.setAttribute('aria-current',s?'true':null); });
  const panel=document.getElementById('p'+i);
  if(panel){ const first=panel.querySelector('button,input,select,[tabindex]:not([tabindex="-1"])'); if(first) first.focus(); }
  if(i===1) up();
  if(i===2) loadCheck();
}

function calc(){
  const kp=+document.getElementById('kp').value, dt=+document.getElementById('dt').value, tc=+document.getElementById('tc').value;
  const m=document.getElementById('met').value;
  if(isNaN(kp)||isNaN(dt)||isNaN(tc)) return toast('Fill all fields');
  if(kp===0||dt===0) return toast('Kp and Dead Time must be > 0');
  let kc,ti=0,td=0;
  if(m==='zn'){kc=1.2*tc/(kp*dt);ti=2*dt;td=0.5*dt;}
  else if(m==='cc'){let r=dt/tc;kc=(tc/(kp*dt))*(1+r/3);ti=dt*(32+6*r)/(13+8*r);td=dt*4/(11+2*r);}
  else{const lf=+document.getElementById('lf').value||1;kc=tc/(kp*(lf*tc+dt));ti=tc;}
  document.getElementById('kc').textContent=isFinite(kc)?kc.toFixed(4):'-';
  document.getElementById('ti').textContent=isFinite(ti)?ti.toFixed(2):'-';
  document.getElementById('td').textContent=isFinite(td)?td.toFixed(2):'-';
  document.getElementById('mt').textContent=m==='zn'?'Ziegler-Nichols':m==='cc'?'Cohen-Coon':'Lambda Tuning';
  const res=document.getElementById('res'); res.style.display='block'; res.dataset.ready='true';
}

function sav(){
  if(document.getElementById('res').dataset.ready!=='true') return toast('Calculate first!');
  let d=JSON.parse(localStorage.getItem('dcs_tunings')||'[]');
  d.push({date:new Date().toLocaleString('en-PH'),tag:document.getElementById('tag').value||'No Tag',method:document.getElementById('met').value,
          kc:document.getElementById('kc').textContent,ti:document.getElementById('ti').textContent,td:document.getElementById('td').textContent});
  localStorage.setItem('dcs_tunings',JSON.stringify(d));
  toast('Saved successfully!');
  tab(3);
}

function del(index){
  let d=JSON.parse(localStorage.getItem('dcs_tunings')||'[]');
  d.splice(d.length-1-index,1);
  localStorage.setItem('dcs_tunings',JSON.stringify(d));
  toast('Deleted!');
  load();
}

function escapeHtml(t){return String(t).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function load(){
  const d=JSON.parse(localStorage.getItem('dcs_tunings')||'[]');
  const list=document.getElementById('list'); list.innerHTML='';
  if(!d.length){list.innerHTML='<p style="text-align:center;color:#aaa">No saved tunings yet</p>';return;}
  d.slice().reverse().forEach((x,i)=>{
    const div=document.createElement('div');div.className='res';
    const b=document.createElement('b');b.textContent=x.tag||'No Tag';
    const p=document.createElement('div');p.style.marginTop='6px';
    p.innerHTML=`<br> → Kc= | Ti=s | Td=s`;
    const delBtn=document.createElement('button');delBtn.textContent='Delete';delBtn.className='del-btn';
    delBtn.onclick=()=>del(i);
    div.append(b,p,delBtn); list.appendChild(div);
  });
}

function escapeCSV(s){return `""`;}
function csv(){
  const d=JSON.parse(localStorage.getItem('dcs_tunings')||'[]');
  if(!d.length) return toast('No data to export');
  let c="Date,Tag,Method,Kc,Ti,Td\n"+d.map(x=>[x.date,x.tag,x.method,x.kc,x.ti,x.td].map(escapeCSV).join(',')).join('\n');
  const blob=new Blob([c],{type:'text/csv'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='DCS_Tunings_PH.csv'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
  toast('CSV exported!');
}

function wa(){
  const d=JSON.parse(localStorage.getItem('dcs_tunings')||'[]');
  if(!d.length) return toast('No data');
  const l=d[d.length-1];
  window.open('https://api.whatsapp.com/send?text='+encodeURIComponent(`Philippine Flag DCS Result\nLoop: \n\nKc= | Ti=s | Td=s\n`),'_blank','noopener');
}

function up(){ const t=document.getElementById('typ').value; const u=conv[t].u; ['fu','tu'].forEach(id=>document.getElementById(id).innerHTML=u.map(x=>`<option></option>`).join('')); document.getElementById('tu').selectedIndex=1;cv(); }
function cv(){ const v=+document.getElementById('fv').value; if(isNaN(v)){document.getElementById('tv').value='';return;} const t=document.getElementById('typ').value; let r; if(t==='temp'){ let c=document.getElementById('fu').value==='°C'?v:document.getElementById('fu').value==='°F'?(v-32)*5/9:v-273.15; r=document.getElementById('tu').value==='°C'?c:document.getElementById('tu').value==='°F'?c*9/5+32:c+273.15; }else if(t==='curr'){ let b=document.getElementById('fu').value==='mA'?v:(v/100)*16+4; r=document.getElementById('tu').value==='mA'?b:((b-4)/16)*100; }else{ const f=conv[t].f; r=v*(f[document.getElementById('fu').value]/f[document.getElementById('tu').value]); } document.getElementById('tv').value=isFinite(r)?r.toFixed(6):''; }

function loadCheck(){for(let i=1;i<=8;i++)if(localStorage.getItem('check'+i)==='true')document.getElementById('c'+i).checked=true;}
function saveCheck(){for(let i=1;i<=8;i++)localStorage.setItem('check'+i,document.getElementById('c'+i).checked);}
function resetCheck(){if(confirm('Reset checklist?'))for(let i=1;i<=8;i++){document.getElementById('c'+i).checked=false;localStorage.removeItem('check'+i);}}
document.querySelectorAll('#p2 input[type=checkbox]').forEach(c=>c.onchange=saveCheck);

function init(){
  up();load();loadCheck();
  document.querySelectorAll('.sec').forEach((p,i)=>p.setAttribute('aria-hidden',i===0?'false':'true'));
  const tabs=Array.from(document.querySelectorAll('.tab'));
  tabs.forEach((b,i)=>b.addEventListener('click',()=>tab(i)));
  tabs.forEach((b,i)=>b.addEventListener('keydown',e=>{ if(['ArrowRight','ArrowLeft','Home','End'].includes(e.key)){ e.preventDefault(); let n=i; if(e.key==='ArrowRight')n=(i+1)%tabs.length; else if(e.key==='ArrowLeft')n=(i-1+tabs.length)%tabs.length; else if(e.key==='Home')n=0; else if(e.key==='End')n=tabs.length-1; tabs[n].focus(); tab(n); }}));
  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>